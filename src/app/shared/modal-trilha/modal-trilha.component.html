<!-- Modal Overlay -->
<div class="modal-trilha-overlay" (click)="onModalClose()">
  <div class="modal-trilha-bg"></div>
  
  <div class="modal-trilha-wrapper">
    <div class="modal-trilha-container" [class]="size" (click)="$event.stopPropagation()">
      
      <!-- ==================== MODO: SELE√á√ÉO DE ETAPAS ==================== -->
      <ng-container *ngIf="modoAtual === 'selecao'">
        <div class="modal-trilha-header">
          <div>
            <h2 class="modal-trilha-title">{{ trilhaData.titulo }}</h2>
            <p class="modal-trilha-subtitle" *ngIf="trilhaData.descricao">{{ trilhaData.descricao }}</p>
          </div>
          <button class="modal-trilha-close" (click)="onModalClose()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="modal-trilha-content">
          <div class="etapas-container">
            
            <!-- Quest√µes Pr√© -->
            <div class="etapa-card" [class.bloqueada]="etapaBloqueada('questoes-pre')" [class.completa]="etapasCompletas.has('questoes-pre')">
              <div class="etapa-numero">1</div>
              <div class="etapa-info">
                <h3>Quest√µes de Aquecimento</h3>
                <p>{{ getQuantidade('questoes-pre') }} quest√µes</p>
                <div class="etapa-status" *ngIf="etapasCompletas.has('questoes-pre')">‚úì Conclu√≠do</div>
              </div>
              <button class="btn-etapa" [disabled]="etapaBloqueada('questoes-pre')" (click)="iniciarEtapa('questoes-pre')">
                {{ etapasCompletas.has('questoes-pre') ? 'Refazer' : 'Iniciar' }}
              </button>
            </div>

            <div class="etapa-seta">‚Üí</div>

            <!-- Aulas -->
            <div class="etapa-card" [class.bloqueada]="etapaBloqueada('aulas')" [class.completa]="etapasCompletas.has('aulas')">
              <div class="etapa-numero">2</div>
              <div class="etapa-info">
                <h3>V√≠deo Aulas</h3>
                <p>{{ getQuantidade('aulas') }} aulas</p>
                <div class="etapa-status" *ngIf="etapasCompletas.has('aulas')">‚úì Conclu√≠do</div>
                <div class="etapa-bloqueio" *ngIf="etapaBloqueada('aulas')">üîí Bloqueado</div>
              </div>
              <button class="btn-etapa" [disabled]="etapaBloqueada('aulas')" (click)="iniciarEtapa('aulas')">
                {{ etapasCompletas.has('aulas') ? 'Rever' : 'Assistir' }}
              </button>
            </div>

            <div class="etapa-seta">‚Üí</div>

            <!-- Quest√µes P√≥s -->
            <div class="etapa-card" [class.bloqueada]="etapaBloqueada('questoes-pos')" [class.completa]="etapasCompletas.has('questoes-pos')">
              <div class="etapa-numero">3</div>
              <div class="etapa-info">
                <h3>Quest√µes P√≥s-Teste</h3>
                <p>{{ getQuantidade('questoes-pos') }} quest√µes</p>
                <div class="etapa-status" *ngIf="etapasCompletas.has('questoes-pos')">‚úì Conclu√≠do</div>
                <div class="etapa-bloqueio" *ngIf="etapaBloqueada('questoes-pos')">üîí Bloqueado</div>
              </div>
              <button class="btn-etapa" [disabled]="etapaBloqueada('questoes-pos')" (click)="iniciarEtapa('questoes-pos')">
                {{ etapasCompletas.has('questoes-pos') ? 'Refazer' : 'Iniciar' }}
              </button>
            </div>

            <div class="etapa-seta">‚Üí</div>

            <!-- Flashcards -->
            <div class="etapa-card" [class.bloqueada]="etapaBloqueada('flashcards')" [class.completa]="etapasCompletas.has('flashcards')">
              <div class="etapa-numero">4</div>
              <div class="etapa-info">
                <h3>Flashcards</h3>
                <p>{{ getQuantidade('flashcards') }} flashcards</p>
                <div class="etapa-status" *ngIf="etapasCompletas.has('flashcards')">‚úì Conclu√≠do</div>
                <div class="etapa-bloqueio" *ngIf="etapaBloqueada('flashcards')">üîí Bloqueado</div>
              </div>
              <button class="btn-etapa" [disabled]="etapaBloqueada('flashcards')" (click)="iniciarEtapa('flashcards')">
                {{ etapasCompletas.has('flashcards') ? 'Rever' : 'Revisar' }}
              </button>
            </div>

          </div>
        </div>

        <div class="modal-trilha-progress">
          <div class="progress-label">
            <span>Progresso da Trilha</span>
            <span class="progress-value">{{ getPorcentagemProgresso() }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getPorcentagemProgresso()"></div>
          </div>
        </div>
      </ng-container>

      <!-- ==================== MODO: EXECUTANDO QUEST√ïES ==================== -->
      <ng-container *ngIf="modoAtual === 'executando' && (etapaAtual === 'questoes-pre' || etapaAtual === 'questoes-pos')">
        <div class="modal-trilha-header questoes-header">
          <div class="questoes-header-info">
            <button class="btn-voltar" (click)="voltarParaSelecao()">‚Üê Voltar</button>
            <div>
              <h2 class="modal-trilha-title">{{ tipoQuestoesAtual === 'pre' ? 'Quest√µes de Aquecimento' : 'Quest√µes P√≥s-Teste' }}</h2>
              <p class="modal-trilha-subtitle">Quest√£o {{ questaoAtualIndex + 1 }} de {{ totalQuestoes }}</p>
            </div>
          </div>
          <button class="modal-trilha-close" (click)="onModalClose()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="modal-trilha-content questoes-content">
          <div class="questao-container" *ngIf="questaoAtual">
            <div class="questao-info-header">
              <span class="questao-badge">ID: {{ questaoAtual.id }}</span>
              <span class="questao-badge">Tema: {{ questaoAtual.assunto }}</span>
              <span class="questao-badge">Ano: {{ questaoAtual.ano }}</span>
            </div>
						<div class="questao-content">
							<div class="questao-enunciado">
								<p>{{ questaoAtual.enunciado }}</p>
							</div>
							
							<div class="questao-alternativas">
								<div *ngFor="let alt of questaoAtual.alternativas" 
								class="alternativa-item"
								[class.selecionada]="respostaSelecionada(alt.letra) && !jaRespondeu"
								[class.correta]="jaRespondeu && alt.letra === questaoAtual.respostaCorreta"
								[class.incorreta]="jaRespondeu && respostaSelecionada(alt.letra) && alt.letra !== questaoAtual.respostaCorreta"
								(click)="selecionarResposta(alt.letra)">
                <div class="alternativa-radio">
									<span class="radio-circle" [class.checked]="respostaSelecionada(alt.letra)"></span>
                </div>
                <div class="alternativa-content">
									<strong>{{ alt.letra }}</strong>
                  <span>{{ alt.texto }}</span>
                </div>
              </div>
						</div>
            </div>
          </div>
        </div>

        <div class="questoes-footer">
          <div class="right-buttons">
            <button class="btn-anterior" [disabled]="questaoAtualIndex === 0" (click)="questaoAnterior()">
              Anterior
            </button>
            <button class="btn-responder" 
                    [disabled]="!respostasUsuario.has(questaoAtualIndex) || jaRespondeu"
                    (click)="responderQuestao()">
              Responder
            </button>
            <button class="btn-proxima" 
                    [disabled]="!jaRespondeu"
                    (click)="proximaQuestao()">
              {{ questaoAtualIndex === totalQuestoes - 1 ? 'Finalizar' : 'Pr√≥xima' }}
            </button>
          </div>
        </div>
      </ng-container>

      <!-- ==================== MODO: RESUMO ==================== -->
      <ng-container *ngIf="modoAtual === 'resumo'">
        <div class="modal-trilha-header resumo-header">
          <div>
            <h2 class="modal-trilha-title">Voc√™ desbloqueou o pr√≥ximo passo!</h2>
            <p class="modal-trilha-subtitle">D√™ continuidade e assista a aula para fixar o conte√∫do.</p>
          </div>
          <button class="modal-trilha-close" (click)="onModalClose()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="modal-trilha-content resumo-content">
          <!-- Cards de Estat√≠sticas -->
          <div class="resumo-stats-cards" *ngIf="etapaAtual === 'questoes-pre' || etapaAtual === 'questoes-pos'">
            <div class="card-estatistica-resumo">
              <img src="assets/Icons/x.svg" alt="√çcone de Respostas Erradas">
              <div class="card-text-estatistica-resumo">
                <h3>{{ erros }}</h3>
                <p>Respostas Erradas</p>
              </div>
            </div>
            <div class="card-estatistica-resumo">
              <img src="assets/Icons/v.svg" alt="√çcone de Respostas Certas">
              <div class="card-text-estatistica-resumo">
                <h3>{{ acertos }}</h3>
                <p>Respostas Certas</p>
              </div>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="resumo-actions">
            <button class="btn-sair-trilha" (click)="voltarParaSelecao()">
              Sair da trilha
            </button>
            <button class="btn-assistir-agora" 
                    *ngIf="proximaEtapaDesbloqueada()"
                    (click)="iniciarEtapa(proximaEtapaDesbloqueada()!)">
              Assistir agora
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="trilha-completa-message" *ngIf="!proximaEtapaDesbloqueada()">
              <p>üèÜ Parab√©ns! Voc√™ completou todas as etapas desta trilha.</p>
            </div>
          </div>
        </div>
      </ng-container>

    </div>
  </div>
</div>
