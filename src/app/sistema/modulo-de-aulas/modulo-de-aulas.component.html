<div class="container pt-5" *ngIf="!isLoadingPage; else pageLoadingTemplate">

    <div class="container mt-4" *ngIf="!erro; else errorTemplate">
        <div class="header">
            <h1 class="mt-4"><span> | </span>Módulo de {{ descricao }} </h1>
        </div>

        <div class="toolbar-actions">

            <button type="button" class="btn-voltar" (click)="voltarPagina()">
                <i class="fa fa-arrow-left"></i>
                Voltar
            </button>

            <div class="search-container">
                <app-global-search></app-global-search>
            </div>

        </div>

        <div class="grid-container">
            <div class="principal-info">

                <ng-container *ngIf="aulas.length > 0; else noDataTemplate">
                    <div class="video-container">

                        <div class="no-video-selected" *ngIf="!videoAtual">

                            <div class="continue-watching-card" *ngIf="aulaParaContinuar; else emptyState">
                                <div class="bg-decoration"></div>
                                <div class="continue-content">
                                    <span class="badge-continue">
                                        <i class="fas fa-history"></i> Continue de onde parou
                                    </span>

                                    <h2 class="next-lesson-title">
                                        {{ aulaParaContinuar.titulo }}
                                    </h2>

                                    <button class="btn-play-hero" (click)="continuarDeOndeParou()">
                                        <div class="play-icon-bg">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        <span>Assistir Agora</span>
                                    </button>
                                </div>
                            </div>

                            <ng-template #emptyState>
                                <div class="placeholder-content">
                                    <i class="fas fa-play-circle"></i>
                                    <h3>Nenhum vídeo selecionado</h3>
                                    <p>Escolha uma aula na lista ao lado para começar a assistir.</p>
                                </div>
                            </ng-template>
                        </div>

                        <div *ngIf="videoAtual && vdoCipherUrl" style="width: 100%; height: 100%; position: relative;">
                            <iframe #vdoIframe [src]="vdoCipherUrl" style="width:100%; height:100%; border:0;"
                                allow="encrypted-media; fullscreen; picture-in-picture" allowfullscreen="true">
                            </iframe>


                        </div>

                        <div *ngIf="videoAtual && !vdoCipherUrl && isLoadingVideo" class="loading-overlay">
                            <span>Carregando player...</span>
                        </div>

                    </div>
                </ng-container>

                <div class="info-aula">
                    <div class="aula-header" *ngIf="aulas.length > 0 && videoAtual">

                        <div class="title-rating-row">
                            <h3>{{ videoAtual?.titulo }}</h3>

                            <div class="actions-right">
                                <div class="estrelas-aula">
                                    <div class="stars">
                                        <img *ngFor="let star of estrelas" [src]="getStarIcon(star)"
                                            [alt]="'Estrela ' + star" class="star-icon"
                                            [class.star-filled]="isStarFilled(star)"
                                            [class.star-hover]="star <= hoverStar" (click)="avaliarAula(star)"
                                            (mouseenter)="onStarHover(star)" (mouseleave)="onStarLeave()"
                                            [attr.aria-label]="'Avaliar com ' + star + ' estrela' + (star > 1 ? 's' : '')"
                                            role="button" tabindex="0">
                                    </div>
                                </div>

                                <button type="button" class="btn-concluir"
                                    [class.concluido]="videosAssistidos[videoAtualIndex]"
                                    (click)="toggleConclusaoAula()">
                                    <i class="fas" [class.fa-check-circle]="videosAssistidos[videoAtualIndex]"
                                        [class.fa-circle]="!videosAssistidos[videoAtualIndex]"></i>
                                    <span>{{ videosAssistidos[videoAtualIndex] ? 'Concluída' : 'Marcar como concluída'
                                        }}</span>
                                </button>
                            </div>
                        </div>

                        <div class="description-rating-row">
                            <p>{{ videoAtual?.descricao }}</p>
                            <div class="average-rating" *ngIf="totalAvaliacoes > 0">
                                <span class="rating-value">{{ mediaAvaliacoes | number:'1.1-1' }}</span>
                                <img [src]="getAverageStarIcon()" alt="Estrela" class="average-star-icon">
                                <span class="rating-count">({{ totalAvaliacoes }} {{ totalAvaliacoes === 1 ? 'avaliação'
                                    : 'avaliações' }})</span>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="aulas.length > 0 && !videoAtual" class="info-placeholder">
                        <h3>Bem-vindo ao Módulo</h3>
                        <p>Selecione uma aula na lista ou clique em "Assistir Agora" para continuar.</p>
                    </div>

                    <div class="arquivos-aula" *ngIf="videoAtual">
                        <h4>Material da Aula</h4>
                        <hr>
                        <div *ngIf="videoAtual.documentos && videoAtual.documentos.length > 0; else noMaterialTemplate">
                            <div class="list-group">
                                <div class="list-group-item" *ngFor="let documento of videoAtual.documentos">
                                    <span>{{ formatFileName(documento.key) }}</span>
                                    <div>
                                        <button class="btn-vizualizar" (click)="viewPdf(documento.url)">
                                            <i class="fas fa-eye" aria-hidden="true"></i>
                                            Visualizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ng-template #noMaterialTemplate>
                            <span class="no-material">Nenhum material adicionado</span>
                        </ng-template>
                    </div>

                    <app-comentarios-aula *ngIf="videoAtual" [referenciaId]="videoAtual.id" [tipo]="'AULA'">
                    </app-comentarios-aula>
                </div>
            </div>

            <div class="playlist-container">
                <app-playlist-mode *ngIf="categoria" [aulas]="aulas" [titulo]="descricao" [categoria]="categoria"
                    [videoAtualIndex]="videoAtualIndex" [videosAssistidos]="videosAssistidos"
                    (aulaSelecionada)="selecionarVideo($event.aula)">
                </app-playlist-mode>
            </div>
        </div>
    </div>
</div>

<ng-template #pageLoadingTemplate>
    <div class="d-flex justify-content-center align-items-center vh-100 flex-column">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <p class="dark-mode">Carregando conteúdo...</p>
    </div>
</ng-template>

<ng-template #noDataTemplate>
    <div class="no-data text-center mt-5">
        <img src="assets/imagens/not-data-aulas.png" alt="Sem aulas" width="200">
        <h4 class="mt-3 dark-mode">Nenhuma aula encontrada</h4>
    </div>
</ng-template>

<ng-template #errorTemplate>
    <div class="text-center m-5">
        <h3 class="something-wrong">Algo deu errado</h3>
        <p class="something-wrong">{{ erro }}</p>
        <button class="btn btn-outline-danger mt-2" (click)="goBack()">Voltar</button>
    </div>
</ng-template>