<!-- Adiciona um container para loading da página inteira -->
<div class="container pt-5" *ngIf="!isLoadingPage; else pageLoadingTemplate">

    <!-- Adiciona um container para o estado de erro -->
    <div class="container mt-4" *ngIf="!erro; else errorTemplate">
        <div class="header">
            <!-- 
        Correção: Usando 'descricao' para mostrar o nome formatado 
        (ex: "Catarata") ao invés da chave do enum (ex: "CATARATA")
      -->
            <h1 class="mt-4"><span> | </span>Modulo de {{ descricao }} </h1>
        </div>

        <div class="grid-container">
            <div class="principal-info">

                <!-- 
          O *ngIf foi movido para um ng-container para que
          o else (noDataTemplate) funcione mesmo se o erro ocorrer
          antes das aulas serem carregadas.
        -->
                <ng-container *ngIf="aulas.length > 0; else noDataTemplate">
                    <div class="video-container">
                        <div class="loading-overlay" *ngIf="isLoadingVideo">
                            <span>Carregando vídeo...</span>
                        </div>

                        <!-- 
              Correção: Removido o primeiro (ended)="marcarComoAssistido(videoAtualIndex)"
              O (ended)="onVideoEnded()" já cuida disso.
            -->
                        <video #videoPlayer controls controlsList="nodownload" class="video-player" [src]="safeVideoUrl"
                            preload="none" *ngIf="videoAtual" (ended)="onVideoEnded()"
                            (contextmenu)="$event.preventDefault()">
                            Seu navegador não suporta o elemento de vídeo.
                        </video>
                    </div>
                </ng-container>

                <div class="info-aula">
                    <div *ngIf="aulas.length > 0 && videoAtual">
                        <h3>{{ videoAtual?.titulo }}</h3>
                        <p>{{ videoAtual?.descricao }}</p>
                    </div>
                    <div class="arquivos-aula">
                        <h4>Material da Aula</h4>
                        <hr>
                        <div
                            *ngIf="videoAtual && videoAtual.documentos && videoAtual.documentos.length > 0; else noMaterialTemplate">
                            <div class="list-group">
                                <div class="list-group-item" *ngFor="let documento of videoAtual?.documentos">
                                    <span>{{ formatFileName(documento.key) }}</span>
                                    <div>
                                        <button class="btn-vizualizar" (click)="viewPdf(documento.url)"><i
                                                class="fas fa-eye"></i>Visualizar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ng-template #noMaterialTemplate>
                            <span>Nenhum material adicionado</span>
                        </ng-template>
                    </div>
                </div>
            </div>
            <div class="playlist-container">
                <!-- 
          Correção: Passando 'descricao' para o título da playlist
        -->
                <!-- 
          Correção de Erro: Adicionado *ngIf="categoria"
          Isso garante que 'categoria' não seja 'undefined' ao ser passado
          para o componente app-playlist-mode, resolvendo o erro de tipo.
        -->
                <app-playlist-mode *ngIf="categoria" [aulas]="aulas" [titulo]="descricao" [categoria]="categoria"
                    [videoAtualIndex]="videoAtualIndex" [videosAssistidos]="videosAssistidos"
                    (aulaSelecionada)="reproduzirVideo($event.aula, $event.index)">
                </app-playlist-mode>
            </div>
        </div>
    </div>
</div>

<!-- Template para "Página Carregando" -->
<ng-template #pageLoadingTemplate>
    <div class="loading-fullpage">
        <!-- Adicione seu componente de spinner ou uma mensagem de loading aqui -->
        <p>Carregando módulo...</p>
    </div>
</ng-template>

<!-- Template para "Nenhuma Aula Encontrada" -->
<ng-template #noDataTemplate>
    <div class="no-data">
        <img src="assets/imagens/not-data-aulas.png" alt="No Data">
        <p>Não há nenhuma aula cadastrada para este módulo.</p>
    </div>
</ng-template>

<!-- Template para Erro (ex: categoria não encontrada) -->
<ng-template #errorTemplate>
    <div class="error-container">
        <h2>Erro</h2>
        <p>{{ erro }}</p>
        <button (click)="goBack()">Voltar</button>
    </div>
</ng-template>